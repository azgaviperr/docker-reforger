# Advanced Usage

This section provides advanced guidance for running and managing your Arma Reforger Dedicated Server with Docker.

---

## Should You Use Environment Variables, Environment Files, or Static Configuration Files?

When configuring your Arma Reforger Dedicated Server with Docker, you have several options for managing your server's settings. Each approach has its strengths and is suited for different use cases.

### Environment Variables

Environment variables are ideal for simple and fast deployments. They allow you to quickly set up and modify server configurations without needing additional files. For example:

```yaml
environment:
    - SERVER_NAME=MyServer
    - SERVER_PASSWORD=secret
    - SERVER_PUBLIC_PORT=2001
```

This approach is straightforward and works well for small-scale setups or temporary servers.

### Environment Files

Environment files (`.env`) provide a more robust and flexible way to manage configurations. They allow you to separate configuration data from your `docker-compose.yml` file, making it easier to maintain and version control. For example:

`.env` file:

```bash
# Create the .env file using a Linux command
echo -e "SERVER_NAME=MyServer\nSERVER_PASSWORD=secret\nSERVER_PUBLIC_PORT=2001" > .env
```

```env
# Example content of the .env file
SERVER_NAME=MyServer
SERVER_PASSWORD=secret
SERVER_PUBLIC_PORT=2001
```

`docker-compose.yml`:

```yaml
env_file:
    - ./env_server1
```

This method is recommended for most deployments, especially when combined with a `mods_file.json` for managing mods.

### Static Configuration Files

Static server configuration files, are the file not automaticcaly generated by the launch script using the docker environment. These files can then be modified and reused by setting the `ARMA_CONFIG` environment variable. This approach is particularly useful for creating backups, maintaining a history of changes, or sharing configurations across teams.

#### Example: Creating and Using a Static Configuration File

1. Start the server once to generate the default `docker_generated.json` file:

    ```bash
    docker-compose up
    ```

   You can also use the docker_default.json present in the repository as base.

2. Locate the generated file in the `Configs` directory and rename it to something meaningful, such as `custom_config.json`:

    ```bash
    mv docker_generated.json custom_config.json
    ```

3. Modify the `custom_config.json` file as needed to suit your server's requirements.

4. Set the `ARMA_CONFIG` environment variable to point to the renamed file:

    ```yaml
    environment:
         - ARMA_CONFIG=custom_config.json
    ```

5. Restart the server to apply the changes:

    ```bash
    docker-compose down && docker-compose up
    ```

This method ensures that your server uses a consistent configuration file, which can be version-controlled and shared with others.

#### Example: Generating and Versioning a Static Configuration File

1. Start the server once to generate the default `docker_generated.json` file.
2. Rename the file to something meaningful, such as `backup_config.json`.
3. Add the file to your version control system (e.g., Git) to track changes over time.

   ```bash
   mv docker_generated.json backup_config.json
   git add backup_config.json
   git commit -m "Initial server configuration backup"
   ```

4. Use the renamed file by setting the `ARMA_CONFIG` environment variable:

   ```yaml
   environment:
      - ARMA_CONFIG=backup_config.json
   ```

### Recommendations

- **For Simple Deployments**: Use full environment variables for quick and easy setup.
- **For Robust and Flexible Deployments**: Use environment files for all configuration variables in conjunction with a `mods_file.json` for managing mods.
- **For Backup and Versioning**: Use static configuration files to create snapshots of your server's settings.

> **Note**: While static configuration files are useful for backups, they reduce the flexibility of this Docker image. For dynamic and scalable setups, environment variables and files are the preferred approach.

## Running Multiple Server Instances

You can host multiple Arma Reforger servers on the same machine by creating separate services, each with distinct ports and persistent volumes.

### Example: Docker Compose for Two Servers

```yaml
version: "3.8"
services:
    arma-reforger-1:
        image: ghcr.io/acemod/arma-reforger:latest
        container_name: arma-reforger-1
        ports:
            - "2001:2001/udp"
            - "17777:17777/udp"
            - "19999:19999/udp"
        volumes:
            - ./reforger/server1/configs:/reforger/Configs
            - ./reforger/server1/profile:/home/profile
            - ./reforger/shared/workshop:/reforger/workshop
        env_file:
            - ./env_server1

    arma-reforger-2:
        image: ghcr.io/acemod/arma-reforger:latest
        container_name: arma-reforger-2
        ports:
            - "3001:2001/udp"
            - "27777:17777/udp"
            - "29999:19999/udp"
        volumes:
            - ./reforger/server2/configs:/reforger/Configs
            - ./reforger/server2/profile:/home/profile
            - ./reforger/shared/workshop:/reforger/workshop
        env_file:
            - ./env_server2
```

Each server instance uses its own configuration, profile, and workshop directories, along with unique ports.

### Recommendations for Managing Multiple Instances

- **Use Environment Files**: It is recommended to use `.env` files for each server instance. This keeps your `docker-compose.yml` file clean and easy to read, while allowing you to manage instance-specific configurations separately.

- **Separate Compose Files**: Alternatively, you can create multiple `docker-compose.yml` files for each server instance. This allows you to run and manage each instance independently. For example:

```bash
docker-compose -f docker-compose-server1.yml up -d
docker-compose -f docker-compose-server2.yml up -d
```

This approach provides flexibility and simplifies troubleshooting by isolating the configuration of each instance.

### Public Server Port Configuration

When hosting public servers, ensure that the `SERVER_PUBLIC_PORT` environment variable for each server is set to the corresponding exposed port. Additionally, all exposed ports must be unique for each server instance to avoid conflicts.

For example:

```yaml
environment:
    - SERVER_PUBLIC_PORT=2001
```

For the second server:

```yaml
environment:
    - SERVER_PUBLIC_PORT=3001
```

This ensures that each server is correctly visible to the public and avoids port conflicts when running multiple instances.

---

## Custom Configuration Files

To use a custom configuration file:

1. Start the server once to generate `docker_generated.json` in your configs directory.
2. Rename the file (e.g., `my_custom_config.json`) and modify it as needed.
3. Set `ARMA_CONFIG=my_custom_config.json` in your `.env` file or environment section.
4. Restart the server.

---

## Using Mods

You can load mods using either the `GAME_MODS_IDS_LIST` environment variable or a JSON file specified by `GAME_MODS_JSON_FILE_PATH`.

### Why Choose One Over the Other?

- **`GAME_MODS_IDS_LIST`**:
  - Simple and quick for small mod lists.
  - Suitable for setups with minimal complexity.

- **`GAME_MODS_JSON_FILE_PATH`**:
  - Ideal for managing long mod lists.
  - Allows specifying additional metadata, such as mod versions or load order.
  - Facilitates version control and collaboration by tracking changes to the JSON file.

### Example: Using `GAME_MODS_IDS_LIST`

```yaml
environment:
        - GAME_MODS_IDS_LIST=59B657D731E2A11D,5D6EA74A94173EDF,5D6EBC81EB1842EF
```

### Example: Using `GAME_MODS_JSON_FILE_PATH`

```yaml
environment:
        - GAME_MODS_JSON_FILE_PATH=/mods_file.json
volumes:
        - ./mods_file.json:/mods_file.json
```

The JSON file should contain an array of objects, each with at least a `modId` field.

### Example: `mods_file.json` Content

Here is an example of what the `mods_file.json` might look like:

```json
[
        {
                "modId": "59B657D731E2A11D",
                "name": "Mod Name 1",
                "version": "1.0.0"
        },
        {
                "modId": "5D6EA74A94173EDF",
                "name": "Mod Name 2",
                "version": "2.3.1"
        },
        {
                "modId": "5D6EBC81EB1842EF",
                "name": "Mod Name 3",
                "version": "0.9.5"
        }
]
```

This file includes the `modId`, `name`, and `version` fields for each mod. The `modId` is required, while the other fields are optional but can help with organization and clarity.

### Generating the JSON from Inside Arma Reforger

To generate a JSON file for mods directly from the Arma Reforger game:

1. Launch the game and navigate to the Workshop menu.
2. Subscribe to the desired mods.
3. Use the in-game export feature to save the mod list as a JSON file. This file will include all subscribed mods with their IDs and metadata.

You can then use this JSON file with the `GAME_MODS_JSON_FILE_PATH` environment variable.

### Why `mods_file.json` is Preferred for Advanced Mod Management

Using a `mods_file.json` is ideal for:

- **Long Mod Lists**: Managing a large number of mods is easier in a JSON file than in a single environment variable.
- **Complex Setups**: The JSON format allows you to specify additional metadata, such as mod versions or load order, which is not possible with `GAME_MODS_IDS_LIST`.
- **Version Control**: You can track changes to the JSON file in your version control system, ensuring consistency across deployments.
- **Collaboration**: Sharing a JSON file with teammates is more straightforward than sharing environment variables.

This approach provides greater flexibility and organization for managing mods in your server setup.

---

## Additional Server Parameters

You can pass additional parameters to the server binary using the `ARMA_PARAMS` environment variable. This is useful for parameters that do not have specific environment variables assigned. For example:

```yaml
environment:
    - ARMA_PARAMS=-someCustomFlag -anotherFlag
```

---

## Workshop and Install Folder Sharing

To save disk space and reduce download times, you can share the same workshop folder between multiple server instances by mounting the same host directory to `/reforger/workshop` for each service. Note that some mods may not support concurrent access.

Similarly, you can share the install folder between server instances by mounting the same host directory to `/reforger/Install`. This approach avoids redundant downloads of the game files and reduces storage usage. However, ensure that all server instances use the same game version to prevent compatibility issues. This means that server updates must be performed simultaneously for all instances to maintain consistency and avoid potential errors.

---

## Useful Tips

- Always use persistent volumes for `/reforger/Configs`, `/home/profile`, and `/reforger/workshop` to prevent data loss.
- Use strong passwords for admin and RCON access.
- Regularly back up your configuration and profile data.

> **Warning**: Be cautious about who you grant access to your Docker host and server ports. Ensuring a minimum level of security awareness is essential to protect your environment from unauthorized access or malicious activity.
